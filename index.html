<!DOCTYPE-html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nexus Hub â€“ Custom Auth</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .auth-container, .dashboard-container {
            max-width: 450px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
        }
        .form-input, .form-select {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition;
        }
        /* CSS for smooth registration fields toggle */
        #registration-fields {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            margin-top: 0;
        }
        #registration-fields.visible {
            max-height: 200px; /* Enough space for two inputs + margin */
            opacity: 1;
            margin-bottom: 1rem;
        }
        .nav-link {
            @apply text-gray-600 hover:text-indigo-600 font-medium transition;
        }
        .active-nav-link {
            @apply text-indigo-600 font-semibold;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col">

        <!-- Loading View -->
        <div id="loading-view" class="min-h-screen flex items-center justify-center p-4">
            <div class="flex flex-col items-center space-y-4">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                <p class="text-gray-600">Initializing app and checking user session...</p>
            </div>
        </div>

        <!-- Authentication View -->
        <div id="auth-view" class="min-h-screen flex items-center justify-center p-4 hidden">
            <div class="auth-container bg-white p-8 rounded-2xl w-full">
                <h2 id="auth-title" class="text-3xl font-bold text-center mb-6 text-gray-800">Sign In</h2>
                <form id="auth-form" onsubmit="event.preventDefault(); handleSubmit();" class="space-y-4">
                    
                    <!-- Registration Fields -->
                    <div id="registration-fields" class="space-y-4">
                        <input type="text" id="username" placeholder="Username (e.g., JaneDoe123)" class="form-input">
                        <select id="role" class="form-select">
                            <option value="learner">Learner</option>
                            <option value="mentor">Mentor</option>
                        </select>
                    </div>

                    <input type="email" id="email" placeholder="Email Address" required class="form-input">
                    <input type="password" id="password" placeholder="Password (min 6 characters)" required class="form-input">

                    <button type="submit" id="submit-button" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition disabled:opacity-50">
                        Sign In
                    </button>
                </form>
                <p id="auth-error" class="text-red-500 text-sm mt-3 text-center hidden"></p>
                <div class="mt-6 text-center">
                    <button id="toggle-auth" class="text-sm text-indigo-600 hover:text-indigo-800 transition">
                        Need an account? Sign Up
                    </button>
                </div>
            </div>
        </div>

        <!-- App View (Main Application) -->
        <div id="app-view" class="flex-grow hidden">
            <!-- Navbar -->
            <nav class="bg-white shadow-md sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <span class="text-2xl font-bold text-indigo-600">Interactive Learning & Collaboration Platform</span>
                        <div class="flex items-center space-x-6">
                            <button id="nav-dashboard" class="nav-link">Dashboard</button>
                            <button id="nav-feed" class="nav-link">Feed</button>
                            <button id="nav-discussions" class="nav-link">Discussions</button>
                            <button onclick="handleSignOut()" class="bg-red-500 text-white text-sm px-4 py-2 rounded-full hover:bg-red-600 transition">Sign Out</button>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
                <div id="main-content-area">
                    <!-- Content will be rendered here -->
                </div>
            </main>

            <!-- Modal -->
            <div id="create-content-modal" class="fixed inset-0 bg-gray-600 bg-opacity-70 hidden items-center justify-center p-4 z-50">
                <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-lg">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-800">Create New Content</h3>
                    <form onsubmit="event.preventDefault(); handleCreateContent(event);" class="space-y-4">
                        <input type="text" id="content-title" placeholder="Content Title" required class="form-input">
                        <select id="content-type" class="form-select" required>
                            <option value="Article">Article</option>
                            <option value="Tutorial">Tutorial</option>
                            <option value="Video">Video</option>
                        </select>
                        <textarea id="content-summary" placeholder="Summary or Description" rows="4" required class="form-input"></textarea>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('create-content-modal')" class="px-4 py-2 text-gray-600 rounded-lg hover:bg-gray-100">Cancel</button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Publish</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Initialization and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signOut, 
            onAuthStateChanged,
            signInWithCustomToken,
            signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            setDoc, 
            doc, 
            getDoc,
            collection,
            query,
            where,
            getDocs,
            addDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app;
        let auth;
        let db;
        const USERS_COLLECTION_PATH = `artifacts/${appId}/public/data/users`; // Using public space for shared NoSQL data

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log('Firebase initialized successfully.');
        } catch (error) {
            console.error('Failed to initialize Firebase:', error);
            document.getElementById('loading-view').innerHTML = `<p class="text-red-600">Error initializing Firebase: ${error.message}</p>`;
        }

        // --- UI Elements ---
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view'); 
        const loadingView = document.getElementById('loading-view');
        const authTitle = document.getElementById('auth-title');
        const submitButton = document.getElementById('submit-button');
        const toggleAuthButton = document.getElementById('toggle-auth');
        const authError = document.getElementById('auth-error');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        
        const registrationFields = document.getElementById('registration-fields');
        const usernameInput = document.getElementById('username');
        const roleSelect = document.getElementById('role');
        const mainContentArea = document.getElementById('main-content-area');

        // State variables
        let isSignInMode = true;
        let currentUserProfile = null;
        let currentUserId = null; // Stores the Firestore document ID (simulated uid)
        window.currentRoute = 'dashboard'; 

        // --- Utility Functions ---

        /** Shows the specified view and hides the others. */
        const showView = (viewId) => {
            loadingView.classList.add('hidden');
            authView.classList.add('hidden');
            appView.classList.add('hidden');

            document.getElementById(viewId).classList.remove('hidden');
        };

        /** Displays an error message in the UI. */
        const displayError = (message) => {
            authError.textContent = message;
            authError.classList.remove('hidden');
        };

        /** Toggles between the Sign In and Sign Up modes in the form. */
        const toggleAuthMode = () => {
            isSignInMode = !isSignInMode;
            if (isSignInMode) {
                authTitle.textContent = 'Sign In';
                submitButton.textContent = 'Sign In';
                toggleAuthButton.textContent = 'Need an account? Sign Up';
                registrationFields.classList.remove('visible'); // Hide fields
            } else {
                authTitle.textContent = 'Register';
                submitButton.textContent = 'Sign Up';
                toggleAuthButton.textContent = 'Already have an account? Sign In';
                registrationFields.classList.add('visible'); // Show fields
            }
            authError.classList.add('hidden'); 
        };
        toggleAuthButton.onclick = toggleAuthMode;

        /** Custom function to display a temporary notification instead of alert() */
        const showNotification = (message) => {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-xl z-50 transition duration-300 transform opacity-0 translate-y-full';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('opacity-0', 'translate-y-full');
            }, 10);

            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-y-full');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        };

        // --- Modal Functions ---
        window.openModal = (id) => {
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('flex');
        };

        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        };

        window.handleCreateContent = (event) => {
            const title = document.getElementById('content-title').value;
            const type = document.getElementById('content-type').value;
            
            console.log('Publishing Content:', { title, type, author: currentUserProfile.username });
            showNotification(`Content "${title}" (${type}) published successfully!`);
            
            // Clear inputs and close
            document.getElementById('content-title').value = '';
            document.getElementById('content-summary').value = '';
            window.closeModal('create-content-modal');
        };
        
        // --- Content Rendering (Simple Router) ---
        
        const updateNavLinks = (activeRoute) => {
             document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active-nav-link');
            });
            const activeLink = document.getElementById(`nav-${activeRoute}`);
            if (activeLink) {
                activeLink.classList.add('active-nav-link');
            }
        };

        const renderDashboard = () => {
            mainContentArea.innerHTML = `
                <h1 class="text-4xl font-extrabold text-gray-900 mb-6">Welcome, ${currentUserProfile.username}!</h1>
                <p class="text-xl text-indigo-600 mb-8">You are logged in as a <span class="font-bold capitalize">${currentUserProfile.role}</span>.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl border border-gray-200">
                        <h3 class="text-xl font-semibold mb-3 text-indigo-600">Your Activity</h3>
                        <p class="text-gray-600">Simulated User ID (Firestore Doc ID): 
                        <code class="text-sm break-all text-indigo-700">${currentUserId}</code></p>
                        <button class="mt-4 bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-indigo-200 transition">View Stats</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-gray-200">
                        <h3 class="text-xl font-semibold mb-3 text-indigo-600">New Content</h3>
                        <p class="text-gray-600">Start creating an article or tutorial.</p>
                        <button onclick="openModal('create-content-modal')" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-indigo-700 transition">Create Content</button>
                    </div>
                </div>
            `;
        };

        const renderFeed = () => {
            mainContentArea.innerHTML = `
                <h1 class="text-4xl font-extrabold text-gray-900 mb-6">Community Feed</h1>
                <p class="text-gray-600 mb-8">See the latest articles and tutorials shared by Mentors and Learners.</p>
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-teal-500">
                        <p class="text-sm text-gray-500">Tutorial by Mentor JaneDoe</p>
                        <h3 class="text-xl font-semibold text-gray-800 mt-1">Deep Dive into CSS Grid Layouts</h3>
                        <p class="text-gray-600 mt-2">A comprehensive guide covering all aspects of responsive grid design without frameworks.</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                        <p class="text-sm text-gray-500">Article by Learner AlexM</p>
                        <h3 class="text-xl font-semibold text-gray-800 mt-1">First Impressions on WebAssembly</h3>
                        <p class="text-gray-600 mt-2">Exploring the performance benefits and complexity of compiling C++ to the web.</p>
                    </div>
                </div>
            `;
        };

        const renderDiscussions = () => {
            mainContentArea.innerHTML = `
                <h1 class="text-4xl font-extrabold text-gray-900 mb-6">Community Discussions</h1>
                <p class="text-gray-600 mb-8">Ask questions, share knowledge, and collaborate with your peers.</p>
                <div class="bg-white p-6 rounded-xl border border-gray-200 text-center">
                    <p class="text-lg text-gray-700">Discussions feature coming soon!</p>
                    <p class="text-sm text-gray-500 mt-1">We are building this feature to support real-time chat and forums.</p>
                </div>
            `;
        };

        const renderContent = () => {
            updateNavLinks(window.currentRoute);
            switch (window.currentRoute) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'feed':
                    renderFeed();
                    break;
                case 'discussions':
                    renderDiscussions();
                    break;
                default:
                    renderDashboard();
            }
        };

        // Setup Navigation Clicks
        document.getElementById('nav-dashboard').onclick = () => { window.currentRoute = 'dashboard'; renderContent(); };
        document.getElementById('nav-feed').onclick = () => { window.currentRoute = 'feed'; renderContent(); };
        document.getElementById('nav-discussions').onclick = () => { window.currentRoute = 'discussions'; renderContent(); };


        // --- Custom NoSQL Authentication & Profile Logic ---

        /** Simulates successful sign-in by setting profile data and navigating to the app view. */
        const simulateSignIn = (userData, docId) => {
            currentUserProfile = userData;
            currentUserId = docId;
            showView('app-view');
            renderContent();
        };

        /** Handles the overall form submission (Sign In or Sign Up). */
        window.handleSubmit = async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            authError.classList.add('hidden');
            submitButton.disabled = true;
            submitButton.textContent = isSignInMode ? 'Signing In...' : 'Registering...';

            if (password.length < 6) {
                displayError('Password must be at least 6 characters.');
                submitButton.disabled = false;
                submitButton.textContent = isSignInMode ? 'Sign In' : 'Sign Up';
                return;
            }

            try {
                const usersCollection = collection(db, USERS_COLLECTION_PATH);

                if (isSignInMode) {
                    // --- Custom Sign In ---
                    const q = query(usersCollection, 
                        where('email', '==', email),
                        where('password', '==', password) // UNSAFE in real apps!
                    );

                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        displayError('Invalid email or password.');
                    } else if (querySnapshot.docs.length > 1) {
                        // Should not happen, but a good check
                        displayError('Multiple accounts found. Contact support.');
                    } else {
                        const docSnap = querySnapshot.docs[0];
                        simulateSignIn(docSnap.data(), docSnap.id);
                        showNotification(`Welcome back, ${docSnap.data().username}!`);
                    }

                } else {
                    // --- Custom Registration ---
                    const username = usernameInput.value.trim();
                    const role = roleSelect.value;

                    if (!username || username.length < 3) {
                        displayError('Username is required and must be at least 3 characters.');
                        return;
                    }
                    
                    // 1. Check if email already exists
                    const emailCheckQ = query(usersCollection, where('email', '==', email));
                    const emailCheckSnapshot = await getDocs(emailCheckQ);

                    if (!emailCheckSnapshot.empty) {
                        displayError('This email is already registered. Please sign in.');
                        return;
                    }

                    // 2. Create user document (Simulated Registration)
                    const newUserDoc = { 
                        email: email, 
                        password: password, // WARNING: Plain text storage for demo purposes!
                        username: username,
                        role: role,
                        createdAt: new Date().toISOString() 
                    };
                    
                    const docRef = await addDoc(usersCollection, newUserDoc);
                    
                    simulateSignIn(newUserDoc, docRef.id);
                    showNotification(`Welcome to Nexus Hub, ${username}! You are registered as a ${role}.`);
                }

            } catch (error) {
                console.error('Auth Error:', error);
                displayError(`Operation failed: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = isSignInMode ? 'Sign In' : 'Sign Up';
            }
        };
        
        /** Handles signing out the current user. */
        window.handleSignOut = async () => {
            // Reset local session state
            currentUserProfile = null;
            currentUserId = null;
            
            // Sign out the Firebase token (though the custom session is local, this cleans up the environment auth)
            try {
                await signOut(auth);
            } catch (error) {
                 console.error('Firebase Sign Out Error:', error);
            }
            showNotification('You have successfully signed out.');
            showView('auth-view');
        };


        // --- Main Authentication Listener (for initial environment token) ---

        const setupAuthListener = () => {
             // 1. Handle initial auth token sign-in
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken)
                    .catch((error) => {
                        console.error("Custom token sign-in failed. Falling back to anonymous.", error);
                        signInAnonymously(auth);
                    });
            } else {
                signInAnonymously(auth);
            }

            // 2. Set up the state listener to control the UI flow
            // This is primarily for managing the initial loading state and ensuring Firebase is ready.
            onAuthStateChanged(auth, (user) => {
                // If a user is already signed in via custom logic, we do nothing.
                if (currentUserProfile) {
                    showView('app-view');
                } else {
                    // Show the login screen after initial environment auth is resolved
                    showView('auth-view');
                }
            });
        };

        // Start the application setup
        setupAuthListener();

    </script>
</body>
</html>
